name: dnscontrol

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
  schedule:
    - cron: '55 5 * * *'

jobs:
  dnscontrol:
    name: Run DNSControl
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:latest
          platforms: all

      - name: Install nix
        uses: cachix/install-nix-action@v26
        with:
          github_access_token: ${{ secrets.AUTOMERGE_TOKEN }}
          extra_nix_config: |
            extra-platforms = i686-linux aarch64-linux arm-linux

      - name: Setup GitHub Actions cache for Nix
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup SSH key
        run: |
          mkdir -p $HOME/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > $HOME/.ssh/id_ed25519
          echo "StrictHostKeyChecking no" > $HOME/.ssh/config
          chmod -R 500 $HOME/.ssh

      - name: Apply DNSControl changes
        run: nix run ".#dnscontrol" -- push

      - name: Copy zone files
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr --delete-after
          path: zones/
          remote_path: /ltnet-zones/
          remote_host: rsync-ci.xuyh0120.win
          remote_port: 2222
          remote_user: ci
          remote_key: ${{ secrets.DEPLOY_KEY }}
